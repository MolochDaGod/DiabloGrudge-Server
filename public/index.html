<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiabloGrudge - Multiplayer Lobby</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23000" width="100" height="100"/><circle cx="50" cy="50" r="40" fill="%23200" opacity="0.1"/></svg>');
            font-family: 'Arial', sans-serif;
            color: #d4af37;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 3em;
            text-shadow: 0 0 20px #d4af37, 0 0 40px #8b0000;
            margin: 20px 0 10px;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: 14px;
            color: #8b7355;
            margin-bottom: 30px;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #d4af37;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff0000;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00ff00;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-container {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 1400px;
            margin-top: 20px;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            flex: 0 0 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 20px;
        }

        .panel-title {
            font-size: 18px;
            color: #d4af37;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            border-bottom: 1px solid #d4af37;
            padding-bottom: 10px;
        }

        .heroes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .hero-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .hero-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.5);
        }

        .hero-card.selected {
            border-color: #ff6b6b;
            box-shadow: 0 0 25px rgba(255, 107, 107, 0.8);
        }

        .hero-avatar {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .hero-name {
            font-size: 16px;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .hero-class {
            font-size: 11px;
            color: #8b7355;
            margin-bottom: 8px;
        }

        .hero-level {
            font-size: 10px;
            color: #7cfc00;
        }

        .btn {
            background: #8b0000;
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            transform: scale(1.02);
        }

        .btn:disabled {
            background: #4a4a4a;
            color: #8b7355;
            border-color: #8b7355;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .game-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .game-item {
            background: #1a1a1a;
            border: 1px solid #d4af37;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-item:hover {
            background: #2d2d2d;
            border-color: #ff6b6b;
        }

        .game-name {
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .game-info {
            font-size: 11px;
            color: #8b7355;
            display: flex;
            justify-content: space-between;
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: #000;
            border: 1px solid #d4af37;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .chat-message {
            margin-bottom: 8px;
            color: #8b7355;
        }

        .chat-message .sender {
            color: #d4af37;
            font-weight: bold;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Arial', sans-serif;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
        }

        .player-item {
            background: #1a1a1a;
            border: 1px solid #d4af37;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .player-name {
            color: #d4af37;
            font-weight: bold;
        }

        .player-status {
            color: #7cfc00;
            font-size: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 3px solid #d4af37;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
        }

        .modal-content h2 {
            color: #d4af37;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #8b7355;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #d4af37;
            color: #d4af37;
            border-radius: 3px;
            font-family: 'Arial', sans-serif;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            color: #8b7355;
            padding: 40px;
            font-size: 14px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            .right-panel {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status">
        <div id="status-dot" class="status-dot"></div>
        <span id="status-text">Connecting...</span>
    </div>

    <h1>‚öîÔ∏è DiabloGrudge Multiplayer ‚öîÔ∏è</h1>
    <p class="subtitle">Select Hero ‚Ä¢ Create/Join Game ‚Ä¢ Play Online</p>

    <div class="main-container">
        <div class="left-panel">
            <!-- Hero Selection -->
            <div class="panel">
                <div class="panel-title">ü¶∏ Your Heroes</div>
                <div id="heroes-grid" class="heroes-grid"></div>
                <div id="empty-heroes" class="empty-state" style="display:none;">
                    No heroes yet. Create your first one!
                </div>
                <div class="btn-actions" style="margin-top: 15px;">
                    <button class="btn btn-small" onclick="openCreateHeroModal()">‚ûï Create Hero</button>
                    <button class="btn btn-small" id="delete-hero-btn" onclick="deleteSelectedHero()" disabled>üóëÔ∏è Delete</button>
                </div>
            </div>

            <!-- Game List -->
            <div class="panel">
                <div class="panel-title">üéÆ Available Games</div>
                <div id="game-list" class="game-list"></div>
                <div id="empty-games" class="empty-state" style="display:none;">
                    No games available. Create one!
                </div>
                <div class="btn-actions" style="margin-top: 15px;">
                    <button class="btn btn-small" onclick="openCreateGameModal()" id="create-game-btn" disabled>‚ûï Create Game</button>
                    <button class="btn btn-small" onclick="refreshGames()">üîÑ Refresh</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- Players Online -->
            <div class="panel">
                <div class="panel-title">üë• Players Online (<span id="player-count">0</span>)</div>
                <div id="player-list" class="player-list"></div>
            </div>

            <!-- Chat -->
            <div class="panel">
                <div class="panel-title">üí¨ Global Chat</div>
                <div class="chat-panel">
                    <div id="chat-messages" class="chat-messages"></div>
                    <div class="chat-input-group">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type message..." disabled>
                        <button class="btn btn-small" onclick="sendChat()" id="send-chat-btn" disabled>Send</button>
                    </div>
                </div>
            </div>

            <!-- Play Button -->
            <button class="btn" id="play-btn" onclick="launchGame()" disabled>‚ñ∂Ô∏è PLAY DIABLO 2</button>
        </div>
    </div>

    <!-- Create Hero Modal -->
    <div id="create-hero-modal" class="modal">
        <div class="modal-content">
            <h2>Create New Hero</h2>
            <div class="form-group">
                <label>Hero Name</label>
                <input type="text" id="hero-name" maxlength="20" placeholder="Enter hero name...">
            </div>
            <div class="form-group">
                <label>Class</label>
                <select id="hero-class">
                    <option value="warrior">‚öîÔ∏è Warrior</option>
                    <option value="wizard">üîÆ Wizard</option>
                    <option value="rogue">üó°Ô∏è Rogue</option>
                    <option value="paladin">üõ°Ô∏è Paladin</option>
                    <option value="necromancer">üíÄ Necromancer</option>
                    <option value="barbarian">ü™ì Barbarian</option>
                    <option value="amazon">üèπ Amazon</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="createHero()">Create</button>
                <button class="btn" onclick="closeModal('create-hero-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Game Modal -->
    <div id="create-game-modal" class="modal">
        <div class="modal-content">
            <h2>Create New Game</h2>
            <div class="form-group">
                <label>Game Name</label>
                <input type="text" id="game-name" maxlength="30" placeholder="Enter game name...">
            </div>
            <div class="form-group">
                <label>Password (Optional)</label>
                <input type="password" id="game-password" maxlength="20" placeholder="Leave empty for public game">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="createGame()">Create Game</button>
                <button class="btn" onclick="closeModal('create-game-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div id="join-game-modal" class="modal">
        <div class="modal-content">
            <h2>Join Game: <span id="join-game-name"></span></h2>
            <div class="form-group" id="password-group" style="display:none;">
                <label>Password</label>
                <input type="password" id="join-password" placeholder="Enter game password">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="confirmJoinGame()">Join</button>
                <button class="btn" onclick="closeModal('join-game-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const HEROES_KEY = 'diablogrudge_heroes';
        const CLASS_ICONS = {
            warrior: '‚öîÔ∏è',
            wizard: 'üîÆ',
            rogue: 'üó°Ô∏è',
            paladin: 'üõ°Ô∏è',
            necromancer: 'üíÄ',
            barbarian: 'ü™ì',
            amazon: 'üèπ'
        };

        let ws = null;
        let playerId = null;
        let selectedHero = null;
        let currentGameId = null;
        let selectedGameToJoin = null;
        let onlinePlayers = [];
        let availableGames = [];

        // WebSocket connection
        function connectToServer() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateConnectionStatus(true);
                console.log('üü¢ Connected to server');
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleServerMessage(msg);
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                console.log('üî¥ Disconnected from server');
                setTimeout(connectToServer, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleServerMessage(msg) {
            switch (msg.type) {
                case 'connected':
                    playerId = msg.playerId;
                    if (selectedHero) {
                        registerWithServer();
                    }
                    break;
                case 'player_list':
                    onlinePlayers = msg.players;
                    renderPlayerList();
                    break;
                case 'chat':
                    addChatMessage(msg.from, msg.message);
                    break;
                case 'games_list':
                    availableGames = msg.games;
                    renderGameList();
                    break;
                case 'game_created':
                case 'game_closed':
                    refreshGames();
                    break;
                case 'joined_game':
                    currentGameId = msg.gameId;
                    addChatMessage('System', `Joined game! Click PLAY to launch D2.`);
                    document.getElementById('play-btn').disabled = false;
                    break;
                case 'error':
                    alert(msg.message);
                    break;
            }
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        function registerWithServer() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'register',
                    hero: selectedHero
                }));
                document.getElementById('chat-input').disabled = false;
                document.getElementById('send-chat-btn').disabled = false;
                document.getElementById('create-game-btn').disabled = false;
                refreshGames();
            }
        }

        // Hero management
        function loadHeroes() {
            const data = localStorage.getItem(HEROES_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveHeroes(heroes) {
            localStorage.setItem(HEROES_KEY, JSON.stringify(heroes));
        }

        function renderHeroes() {
            const heroes = loadHeroes();
            const container = document.getElementById('heroes-grid');
            const emptyState = document.getElementById('empty-heroes');

            container.innerHTML = '';

            if (heroes.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            heroes.forEach((hero, index) => {
                const card = document.createElement('div');
                card.className = `hero-card ${selectedHero?.id === hero.id ? 'selected' : ''}`;
                card.onclick = () => selectHero(index);
                card.innerHTML = `
                    <div class="hero-avatar">${CLASS_ICONS[hero.class]}</div>
                    <div class="hero-name">${hero.name}</div>
                    <div class="hero-class">${hero.class.toUpperCase()}</div>
                    <div class="hero-level">Level ${hero.level || 1}</div>
                `;
                container.appendChild(card);
            });
        }

        function selectHero(index) {
            const heroes = loadHeroes();
            selectedHero = { ...heroes[index], id: index };
            document.getElementById('delete-hero-btn').disabled = false;
            registerWithServer();
            renderHeroes();
        }

        function openCreateHeroModal() {
            document.getElementById('create-hero-modal').classList.add('show');
        }

        function createHero() {
            const name = document.getElementById('hero-name').value.trim();
            const heroClass = document.getElementById('hero-class').value;

            if (!name || name.length < 2) {
                alert('Hero name must be at least 2 characters');
                return;
            }

            const heroes = loadHeroes();
            const newHero = {
                id: Date.now(),
                name: name,
                class: heroClass,
                level: 1,
                createdAt: new Date().toISOString()
            };

            heroes.push(newHero);
            saveHeroes(heroes);

            closeModal('create-hero-modal');
            document.getElementById('hero-name').value = '';
            renderHeroes();
            selectHero(heroes.length - 1);
        }

        function deleteSelectedHero() {
            if (!selectedHero || !confirm('Delete this hero? This cannot be undone!')) return;

            const heroes = loadHeroes();
            heroes.splice(selectedHero.id, 1);
            saveHeroes(heroes);

            selectedHero = null;
            document.getElementById('delete-hero-btn').disabled = true;
            document.getElementById('create-game-btn').disabled = true;
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-chat-btn').disabled = true;
            renderHeroes();
        }

        // Game management
        function openCreateGameModal() {
            if (!selectedHero) {
                alert('Select a hero first!');
                return;
            }
            document.getElementById('create-game-modal').classList.add('show');
        }

        function createGame() {
            const gameName = document.getElementById('game-name').value.trim();
            const password = document.getElementById('game-password').value;

            if (!gameName) {
                alert('Enter a game name');
                return;
            }

            ws.send(JSON.stringify({
                type: 'create_game',
                gameName,
                password: password || null
            }));

            closeModal('create-game-modal');
            document.getElementById('game-name').value = '';
            document.getElementById('game-password').value = '';
        }

        function refreshGames() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_games' }));
            }
        }

        function renderGameList() {
            const container = document.getElementById('game-list');
            const emptyState = document.getElementById('empty-games');

            container.innerHTML = '';

            if (availableGames.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            availableGames.forEach(game => {
                const item = document.createElement('div');
                item.className = 'game-item';
                item.onclick = () => openJoinGameModal(game);
                item.innerHTML = `
                    <div class="game-name">${game.hasPassword ? 'üîí ' : ''}${game.name}</div>
                    <div class="game-info">
                        <span>üë• ${game.players}/${game.maxPlayers}</span>
                        <span>${game.status}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function openJoinGameModal(game) {
            if (!selectedHero) {
                alert('Select a hero first!');
                return;
            }

            selectedGameToJoin = game;
            document.getElementById('join-game-name').textContent = game.name;
            
            const passwordGroup = document.getElementById('password-group');
            if (game.hasPassword) {
                passwordGroup.style.display = 'block';
            } else {
                passwordGroup.style.display = 'none';
            }

            document.getElementById('join-game-modal').classList.add('show');
        }

        function confirmJoinGame() {
            const password = document.getElementById('join-password').value;
            
            ws.send(JSON.stringify({
                type: 'join_game',
                gameId: selectedGameToJoin.id,
                password: password || null
            }));

            closeModal('join-game-modal');
            document.getElementById('join-password').value = '';
        }

        // Chat
        function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            ws.send(JSON.stringify({
                type: 'chat',
                message
            }));

            input.value = '';
        }

        function addChatMessage(from, message) {
            const container = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            msg.innerHTML = `<span class="sender">${from}:</span> ${message}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // Players
        function renderPlayerList() {
            const container = document.getElementById('player-list');
            document.getElementById('player-count').textContent = onlinePlayers.length;

            container.innerHTML = '';

            onlinePlayers.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';
                item.innerHTML = `
                    <span class="player-name">${CLASS_ICONS[player.hero.class]} ${player.hero.name}</span>
                    <span class="player-status">${player.inGame ? 'üéÆ In Game' : '‚úÖ Lobby'}</span>
                `;
                container.appendChild(item);
            });
        }

        // Launch game
        function launchGame() {
            if (!selectedHero) {
                alert('Select a hero first!');
                return;
            }

            localStorage.setItem('diablogrudge_active_hero', JSON.stringify(selectedHero));
            
            // Launch DiabloWeb
            window.open('https://d07riv.github.io/diabloweb/', '_blank');
            
            addChatMessage('System', 'Game launched! Use TCP/IP to connect with other players.');
        }

        // Utils
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // Initialize
        renderHeroes();
        connectToServer();
    </script>
</body>
</html>
